<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro 2025</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 500px; margin: 40px auto; background: #f0f2f5; padding: 20px; }
        nav { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .box { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }
        a { text-decoration: none; color: #007bff; font-weight: bold; }
        .audio-section { border-top: 1px solid #eee; margin-top: 20px; padding-top: 15px; }
        #statusAudio { font-size: 0.85em; color: #d9534f; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <nav>
        <strong>‚ûï Novo</strong> | <a href="/galeria">üñºÔ∏è Ver Galeria</a>
    </nav>

    <div class="box">
        <h2>Cadastrar M√≠dia</h2>
        <input type="text" id="textoInput" placeholder="Descri√ß√£o ou t√≠tulo...">
        
        <!-- Upload de Arquivos (Imagem/V√≠deo) -->
        <input type="file" id="arquivoInput" accept="image/*,video/*">
        <button id="btnSalvar" onclick="salvar()">Enviar Arquivo</button>
    
        <!-- Grava√ß√£o de √Åudio -->
        <div class="audio-section">
            <h3>üéôÔ∏è Gravar √Åudio</h3>
            <button id="btnStart" type="button" style="background: #28a745;">üî¥ Iniciar Grava√ß√£o</button>
            <button id="btnStop" type="button" style="background: #dc3545;" disabled>‚èπÔ∏è Parar e Enviar</button>
            <p id="statusAudio"></p>
        </div>
    </div>

    <script>
        // --- FUN√á√ÉO PARA SALVAR IMAGEM OU V√çDEO ---
        async function salvar() {
            const texto = document.getElementById('textoInput').value;
            const arquivoInput = document.getElementById('arquivoInput');
            const btn = document.getElementById('btnSalvar');

            if (!texto) return alert("Por favor, digite um texto descritivo.");
            if (!arquivoInput.files[0]) return alert("Selecione um arquivo primeiro.");

            const formData = new FormData();
            formData.append('texto', texto);
            formData.append('arquivo', arquivoInput.files[0]);

            btn.disabled = true;
            btn.innerText = "Enviando...";

            try {
                const res = await fetch('/tarefas', { method: 'POST', body: formData });
                if (res.ok) {
                    alert("Arquivo salvo com sucesso!");
                    document.getElementById('textoInput').value = '';
                    arquivoInput.value = '';
                } else {
                    alert("Erro ao salvar no servidor.");
                }
            } catch (err) {
                alert("Erro de conex√£o com o servidor.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Enviar Arquivo";
            }
        }

        // --- L√ìGICA DE GRAVA√á√ÉO DE √ÅUDIO ---
        let mediaRecorder;
        let audioChunks = [];

        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const statusAudio = document.getElementById('statusAudio');

        btnStart.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    const texto = document.getElementById('textoInput').value || "√Åudio Gravado";
                    
                    const formData = new FormData();
                    formData.append('texto', texto);
                    // Nomeia o arquivo com um timestamp para evitar duplicatas
                    formData.append('arquivo', audioBlob, `audio_${Date.now()}.mp3`);

                    statusAudio.innerText = "Enviando √°udio para o banco...";
                    
                    const res = await fetch('/tarefas', { method: 'POST', body: formData });
                    if(res.ok) {
                        alert("√Åudio gravado e salvo com sucesso!");
                        document.getElementById('textoInput').value = '';
                        statusAudio.innerText = "";
                    } else {
                        alert("Erro ao salvar √°udio.");
                    }
                };

                mediaRecorder.start();
                btnStart.disabled = true;
                btnStop.disabled = false;
                statusAudio.innerText = "üé§ Gravando agora...";
            } catch (err) {
                alert("Erro ao acessar microfone. Verifique as permiss√µes do navegador.");
                console.error(err);
            }
        };

        btnStop.onclick = () => {
            mediaRecorder.stop();
            btnStart.disabled = false;
            btnStop.disabled = true;
            statusAudio.innerText = "‚åõ Processando √°udio...";
        };
    </script>
</body>
</html>

