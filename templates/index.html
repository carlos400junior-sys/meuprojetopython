<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro 2025</title>
    <<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <nav>
        <strong>â• Novo</strong> | <a href="/galeria">ğŸ–¼ï¸ Ver Galeria</a>
    </nav>

    <div class="box">
        <h2>Cadastrar MÃ­dia</h2>
        <input type="text" id="textoInput" placeholder="DescriÃ§Ã£o ou tÃ­tulo...">
        
        <!-- Upload de Arquivos (Imagem/VÃ­deo) -->
        <input type="file" id="arquivoInput" accept="image/*,video/*">
        <button id="btnSalvar" onclick="salvar()">Enviar Arquivo</button>
    
        <!-- GravaÃ§Ã£o de Ãudio -->
        <div class="audio-section">
            <h3>ğŸ™ï¸ Gravar Ãudio</h3>
            <button id="btnStart" type="button" style="background: #28a745;">ğŸ”´ Iniciar GravaÃ§Ã£o</button>
            <button id="btnStop" type="button" style="background: #dc3545;" disabled>â¹ï¸ Parar e Enviar</button>
            <p id="statusAudio"></p>
        </div>
    </div>

    <script>
        // --- FUNÃ‡ÃƒO PARA SALVAR IMAGEM OU VÃDEO ---
        async function salvar() {
            const texto = document.getElementById('textoInput').value;
            const arquivoInput = document.getElementById('arquivoInput');
            const btn = document.getElementById('btnSalvar');

            if (!texto) return alert("Por favor, digite um texto descritivo.");
            if (!arquivoInput.files[0]) return alert("Selecione um arquivo primeiro.");

            const formData = new FormData();
            formData.append('texto', texto);
            formData.append('arquivo', arquivoInput.files[0]);

            btn.disabled = true;
            btn.innerText = "Enviando...";

            try {
                const res = await fetch('/tarefas', { method: 'POST', body: formData });
                if (res.ok) {
                    alert("Arquivo salvo com sucesso!");
                    document.getElementById('textoInput').value = '';
                    arquivoInput.value = '';
                } else {
                    alert("Erro ao salvar no servidor.");
                }
            } catch (err) {
                alert("Erro de conexÃ£o com o servidor.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Enviar Arquivo";
            }
        }

        // --- LÃ“GICA DE GRAVAÃ‡ÃƒO DE ÃUDIO ---
        let mediaRecorder;
        let audioChunks = [];

        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const statusAudio = document.getElementById('statusAudio');

        btnStart.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    const texto = document.getElementById('textoInput').value || "Ãudio Gravado";
                    
                    const formData = new FormData();
                    formData.append('texto', texto);
                    // Nomeia o arquivo com um timestamp para evitar duplicatas
                    formData.append('arquivo', audioBlob, `audio_${Date.now()}.mp3`);

                    statusAudio.innerText = "Enviando Ã¡udio para o banco...";
                    
                    const res = await fetch('/tarefas', { method: 'POST', body: formData });
                    if(res.ok) {
                        alert("Ãudio gravado e salvo com sucesso!");
                        document.getElementById('textoInput').value = '';
                        statusAudio.innerText = "";
                    } else {
                        alert("Erro ao salvar Ã¡udio.");
                    }
                };

                mediaRecorder.start();
                btnStart.disabled = true;
                btnStop.disabled = false;
                statusAudio.innerText = "ğŸ¤ Gravando agora...";
            } catch (err) {
                alert("Erro ao acessar microfone. Verifique as permissÃµes do navegador.");
                console.error(err);
            }
        };

        btnStop.onclick = () => {
            mediaRecorder.stop();
            btnStart.disabled = false;
            btnStop.disabled = true;
            statusAudio.innerText = "âŒ› Processando Ã¡udio...";
        };
    </script>
</body>
</html>

